SPLENT_DOCKER_COMPOSE = docker compose -f docker/docker-compose.yml

.PHONY: setup setup-rebuild env-prepare docker-up cli-enter


# ------------------------------------------------------------
#  ENV: Copy .env and inject SPLENT_HOST_PROJECT_DIR
# ------------------------------------------------------------
env-prepare:
	@if [ ! -f ../.env ]; then \
		echo "üöÄ Copying .env.example ‚Üí ../.env"; \
		cp .env.example ../.env; \
		if [ ! -d "$(shell realpath ..)/.vagrant" ]; then \
			echo "üõ†Ô∏è  Injecting real path into SPLENT_HOST_PROJECT_DIR"; \
			grep -qxF "SPLENT_HOST_PROJECT_DIR=$(shell realpath ..)" ../.env || \
			printf "\nSPLENT_HOST_PROJECT_DIR=%s\n" "$(shell realpath ..)" >> ../.env; \
		else \
			echo "üìÅ .vagrant detected ‚Äî injecting /workspace into SPLENT_HOST_PROJECT_DIR"; \
			grep -qxF "SPLENT_HOST_PROJECT_DIR=/workspace" ../.env || \
			printf "\nSPLENT_HOST_PROJECT_DIR=/workspace\n" >> ../.env; \
		fi; \
	else \
		echo "‚úÖ .env already exists ‚Äî skipping copy and injection."; \
	fi


# ------------------------------------------------------------
#  Docker: start environment with correct GID
# ------------------------------------------------------------
docker-up:
	@echo "üê≥ Getting Docker GID..."
	@DOCKER_GID=$$(getent group docker | cut -d: -f3); \
	echo "üê≥ Using GID $$DOCKER_GID"; \
	DOCKER_GID=$$DOCKER_GID $(SPLENT_DOCKER_COMPOSE) up -d


# ------------------------------------------------------------
#  Enter CLI with .bashrc loaded
# ------------------------------------------------------------
cli-enter:
	@echo "üß† Entering SPLENT CLI..."
	@docker exec -it splent_cli_container bash --rcfile /home/splent/.bashrc


# ------------------------------------------------------------
#  SETUP (fresh or existing environment)
# ------------------------------------------------------------
setup: env-prepare docker-up cli-enter


# ------------------------------------------------------------
#  Force rebuild of all images
# ------------------------------------------------------------
setup-rebuild: env-prepare
	@echo "üßπ Stopping existing containers..."
	@$(SPLENT_DOCKER_COMPOSE) down -v --remove-orphans || true

	@echo "üî• Removing old images..."
	@docker image prune -a -f || true

	@echo "üîß Rebuilding with correct Docker GID..."
	@DOCKER_GID=$$(getent group docker | cut -d: -f3); \
	echo "üê≥ Using GID $$DOCKER_GID"; \
	DOCKER_GID=$$DOCKER_GID $(SPLENT_DOCKER_COMPOSE) build --no-cache

	@echo "üöÄ Starting containers fresh..."
	@DOCKER_GID=$$(getent group docker | cut -d: -f3); \
	DOCKER_GID=$$DOCKER_GID $(SPLENT_DOCKER_COMPOSE) up -d --build

	$(MAKE) cli-enter
