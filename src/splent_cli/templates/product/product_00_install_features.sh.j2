#!/bin/bash

# ---------------------------------------------------------------------------
# Creative Commons CC BY 4.0 - SPLENT - Diverso Lab
# ---------------------------------------------------------------------------
# This script installs all editable features listed in the product's
# pyproject.toml under [project.optional-dependencies.features].
# ---------------------------------------------------------------------------

set -e

echo "ğŸš€ [Install features] entrypoint starting..."
echo "ğŸ“¦ Installing editable features listed in [features] of pyproject.toml..."

# Leer features desde el pyproject del producto activo
features=$(python3 -c '
import tomllib
with open("/workspace/{{ product_name }}/pyproject.toml", "rb") as f:
    data = tomllib.load(f)
print("\n".join(data["project"]["optional-dependencies"].get("features", [])))
')

echo "ğŸ“ƒ Features parsed:"
echo "$features"

# Helper para detectar instalaciÃ³n editable
is_installed_editable() {
    local feature=$1
    pip show -f "$feature" 2>/dev/null | grep -q "/workspace/{{ product_name }}/features/$feature"
}

# Bucle de instalaciÃ³n
for feature in $features; do
    feature_path="/workspace/{{ product_name }}/features/$feature"
    if [ -d "$feature_path" ]; then
        if is_installed_editable "$feature"; then
            echo "âœ… $feature already installed in editable mode."
        else
            echo "ğŸ” Installing $feature in editable mode from $feature_path..."
            pip install --no-cache-dir --root-user-action=ignore -e "$feature_path" || echo "âŒ Error installing $feature"
        fi
    else
        echo "âš ï¸  $feature not found locally at $feature_path. Skipping."
    fi
done

echo "âœ… [Install features] entrypoint finished."
