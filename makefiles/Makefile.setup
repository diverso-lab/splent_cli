SPLENT_DOCKER_COMPOSE = docker compose -f docker/docker-compose.yml

.PHONY: setup setup-rebuild

setup:
	@if [ ! -f ../.env ]; then \
		echo "ğŸš€ Copying .env.example â†’ ../.env"; \
		cp .env.example ../.env; \
		if [ ! -d "$(shell realpath ..)/.vagrant" ]; then \
			echo "ğŸ› ï¸  Injecting real path into SPLENT_HOST_PROJECT_DIR"; \
			grep -qxF "SPLENT_HOST_PROJECT_DIR=$(shell realpath ..)" ../.env || \
			printf "\nSPLENT_HOST_PROJECT_DIR=%s\n" "$(shell realpath ..)" >> ../.env; \
		else \
			echo "ğŸ“ .vagrant detected â€” injecting /workspace into SPLENT_HOST_PROJECT_DIR"; \
			grep -qxF "SPLENT_HOST_PROJECT_DIR=/workspace" ../.env || \
			printf "\nSPLENT_HOST_PROJECT_DIR=/workspace\n" >> ../.env; \
		fi; \
	else \
		echo "âœ… .env already exists â€” skipping copy and injection."; \
	fi

	@echo "ğŸ³ Getting Docker GID..."
	@DOCKER_GID=$$(getent group docker | cut -d: -f3); \
	echo "ğŸ³ Using GID $$DOCKER_GID"; \
	DOCKER_GID=$$DOCKER_GID $(SPLENT_DOCKER_COMPOSE) up -d --build

	@echo "ğŸ§  Entering SPLENT CLI..."
	@docker exec -it splent_cli_container bash


# ------------------------------------------------------------
# Force rebuild of all images (use when Dockerfile changes)
# ------------------------------------------------------------
setup-rebuild:
	@echo "ğŸ§¹ Stopping existing containers..."
	@$(SPLENT_DOCKER_COMPOSE) down -v --remove-orphans || true

	@echo "ğŸ”¥ Removing old images..."
	@docker image prune -a -f || true

	@echo "ğŸ”§ Rebuilding with correct Docker GID..."
	@DOCKER_GID=$$(getent group docker | cut -d: -f3); \
	echo "ğŸ³ Using GID $$DOCKER_GID"; \
	DOCKER_GID=$$DOCKER_GID $(SPLENT_DOCKER_COMPOSE) build --no-cache

	@echo "ğŸš€ Starting containers fresh..."
	@DOCKER_GID=$$(getent group docker | cut -d: -f3); \
	DOCKER_GID=$$DOCKER_GID $(SPLENT_DOCKER_COMPOSE) up -d

	@echo "ğŸ§  Entering SPLENT CLI..."
	@docker exec -it splent_cli_container bash
